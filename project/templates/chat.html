<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Chat App</title>
  <link rel="stylesheet" href="/static/css/style.css">
</head>
<body data-username="{{ username }}" data-user-id="{{ user_id }}">
  <div class="chat-app">

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h2>💬 Chat</h2>
        </div>

        <!-- Search & Add Friend -->
        <div class="search-box">
            <input type="text" id="search-user" placeholder="Tìm kiếm người dùng..." />
            <ul id="search-results" class="search-results"></ul>
        </div>

        <!-- User & Group list -->
        <ul id="user-list" class="user-list">
            <li class="section-title">📩 Lời mời kết bạn</li>
            <ul id="friend-requests" class="friend-requests"></ul>

            <li data-room="global" class="active">🌍 Phòng chung</li>

            <li class="section-title">👥 Nhóm</li>
            <ul id="groups-list">
                {% for g in groups %}
                    <li data-room="group_{{ g.id }}" data-group-id="{{ g.id }}" class="group-item">
                        <span class="group-name">👥 {{ g.name }}</span>
                        <button class="group-manage-btn" data-group-id="{{ g.id }}" data-group-name="{{ g.name }}" title="Quản lý nhóm">⚙️</button>
                    </li>
                {% endfor %}
            </ul>

            <li class="section-title">👤 Bạn bè</li>
            {% for u in users %}
                <li data-room="user_{{ u.id }}" data-user-id="{{ u.id }}">👤 {{ u.username }}</li>
            {% endfor %}
        </ul>

        <!-- Tạo nhóm mới -->
        <div class="create-group">
            <h4>➕ Tạo nhóm mới</h4>
            <input type="text" id="new-group-name" placeholder="Tên nhóm..." />
            
            <div class="member-selection">
                <label>Chọn thành viên:</label>
                <div id="new-group-members" class="member-list">
                    {% for u in users %}
                        <div class="member-item">
                            <span class="member-name">{{ u.username }}</span>
                            <button class="add-member-btn" data-user-id="{{ u.id }}" data-username="{{ u.username }}">Thêm</button>
                        </div>
                    {% endfor %}
                </div>
                <div class="selected-count">Đã chọn: <span id="selected-count">0</span> thành viên</div>
            </div>
            
            <button id="create-group-btn">Tạo nhóm</button>
        </div>

        <!-- Quản lý nhóm (ẩn mặc định) -->
        <div id="group-management" class="group-management">
            <div class="management-header">
                <h4 id="manage-group-title">⚙️ Quản lý nhóm</h4>
                <button class="close-management">✕</button>
            </div>
            
            <div class="add-member-section">
                <label>Thêm thành viên mới:</label>
                <div id="add-group-members" class="member-list">
                    <!-- Sẽ được populate bằng JS -->
                </div>
                <div class="selected-count">Đã chọn: <span id="add-selected-count">0</span> thành viên</div>
                <button id="add-members-btn">Thêm vào nhóm</button>
            </div>
        </div>
    </aside>

    <!-- Chat main -->
    <main class="chat-main">
      <div class="chat-header">
        <h3 id="room-title">Phòng chung</h3>
        <a href="/logout" class="logout-btn">Đăng xuất</a>
      </div>

      <div id="chat-box" class="chat-box">
        {% for msg in messages %}
            <div class="msg {% if msg.sender_id == 0 %}system{% elif msg.sender.username == username %}self{% else %}other{% endif %}">
                <div class="bubble">
                    [{{ msg.timestamp | hms_local }}] 
                    <b>{{ msg.sender.username if msg.sender else 'System' }}</b>: {{ msg.content | e }}
                </div>
            </div>
        {% endfor %}
      </div>

      <div class="chat-input">
        <input type="text" id="message" placeholder="Nhập tin nhắn..." />
        <button id="send">➤</button>
      </div>
    </main>

  </div>

  <!-- Socket.IO client -->
  <script src="https://cdn.socket.io/4.7.1/socket.io.min.js"></script>
  <script src="/static/app.js"></script>
</body>
</html>