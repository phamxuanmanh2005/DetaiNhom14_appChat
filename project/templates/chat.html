<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Chat App</title>
  <link rel="stylesheet" href="/static/css/style.css">
</head>
<body data-username="{{ username }}" data-user-id="{{ user_id }}">
  <div class="chat-app">

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h2>ğŸ’¬ Chat</h2>
        </div>

        <!-- Search & Add Friend -->
        <div class="search-box">
            <input type="text" id="search-user" placeholder="TÃ¬m kiáº¿m ngÆ°á»i dÃ¹ng..." />
            <ul id="search-results" class="search-results"></ul>
        </div>

        <!-- User & Group list -->
        <ul id="user-list" class="user-list">
            <li class="section-title">ğŸ“© Lá»i má»i káº¿t báº¡n</li>
            <ul id="friend-requests" class="friend-requests"></ul>

            <li data-room="global" class="active">ğŸŒ PhÃ²ng chung</li>

            <li class="section-title">ğŸ‘¥ NhÃ³m</li>
            <ul id="groups-list">
                {% for g in groups %}
                    <li data-room="group_{{ g.id }}" data-group-id="{{ g.id }}" class="group-item">
                        <span class="group-name">ğŸ‘¥ {{ g.name }}</span>
                        <button class="group-manage-btn" data-group-id="{{ g.id }}" data-group-name="{{ g.name }}" title="Quáº£n lÃ½ nhÃ³m">âš™ï¸</button>
                    </li>
                {% endfor %}
            </ul>

            <li class="section-title">ğŸ‘¤ Báº¡n bÃ¨</li>
            {% for u in users %}
                <li data-room="user_{{ u.id }}" data-user-id="{{ u.id }}">ğŸ‘¤ {{ u.username }}</li>
            {% endfor %}
        </ul>

        <!-- Táº¡o nhÃ³m má»›i -->
        <div class="create-group">
            <h4>â• Táº¡o nhÃ³m má»›i</h4>
            <input type="text" id="new-group-name" placeholder="TÃªn nhÃ³m..." />
            
            <div class="member-selection">
                <label>Chá»n thÃ nh viÃªn:</label>
                <div id="new-group-members" class="member-list">
                    {% for u in users %}
                        <div class="member-item">
                            <span class="member-name">{{ u.username }}</span>
                            <button class="add-member-btn" data-user-id="{{ u.id }}" data-username="{{ u.username }}">ThÃªm</button>
                        </div>
                    {% endfor %}
                </div>
                <div class="selected-count">ÄÃ£ chá»n: <span id="selected-count">0</span> thÃ nh viÃªn</div>
            </div>
            
            <button id="create-group-btn">Táº¡o nhÃ³m</button>
        </div>

        <!-- Quáº£n lÃ½ nhÃ³m (áº©n máº·c Ä‘á»‹nh) -->
        <div id="group-management" class="group-management">
            <div class="management-header">
                <h4 id="manage-group-title">âš™ï¸ Quáº£n lÃ½ nhÃ³m</h4>
                <button class="close-management">âœ•</button>
            </div>
            
            <div class="add-member-section">
                <label>ThÃªm thÃ nh viÃªn má»›i:</label>
                <div id="add-group-members" class="member-list">
                    <!-- Sáº½ Ä‘Æ°á»£c populate báº±ng JS -->
                </div>
                <div class="selected-count">ÄÃ£ chá»n: <span id="add-selected-count">0</span> thÃ nh viÃªn</div>
                <button id="add-members-btn">ThÃªm vÃ o nhÃ³m</button>
            </div>
        </div>
    </aside>

    <!-- Chat main -->
    <main class="chat-main">
      <div class="chat-header">
        <h3 id="room-title">PhÃ²ng chung</h3>
        <a href="/logout" class="logout-btn">ÄÄƒng xuáº¥t</a>
      </div>

      <div id="chat-box" class="chat-box">
        {% for msg in messages %}
            <div class="msg {% if msg.sender_id == 0 %}system{% elif msg.sender.username == username %}self{% else %}other{% endif %}">
                <div class="bubble">
                    [{{ msg.timestamp | hms_local }}] 
                    <b>{{ msg.sender.username if msg.sender else 'System' }}</b>: {{ msg.content | e }}
                </div>
            </div>
        {% endfor %}
      </div>

      <div class="chat-input">
        <input type="text" id="message" placeholder="Nháº­p tin nháº¯n..." />
        <button id="send">â¤</button>
      </div>
    </main>

  </div>

  <!-- Socket.IO client -->
  <script src="https://cdn.socket.io/4.7.1/socket.io.min.js"></script>
  <script src="/static/app.js"></script>
</body>
</html>